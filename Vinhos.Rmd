---
title: "Vinhos"
author: "Matheus, Murilo"
output: html_document
---
##pacotes
```{r pacotes}
source("func.R")
# packages
packages <- c("Rcpp",
              "tidyverse",
              "magrittr",
              "tidyverse",
              "broom",
              "corrplot",
              "ca",
              "RColorBrewer",
              "gridExtra",
              "forcats",
              "rpart",
              "rpart.plot",
              "pROC",
              "randomForest",
              "ggbiplot")

ipak(packages)

#library(devtools)
#install_github("vqv/ggbiplot")
```

##Carregando os dados

```{r}
##leitura dos dados
red <- read.csv("winequality/winequality-red.csv",header = T,sep = ";") %>% 
  mutate(vinho = as.factor("red"))

white <- read.csv("winequality/winequality-white.csv",header = T,sep = ";") %>% mutate(vinho =as.factor("white"))
dados <- rbind(white,red)

```
##Descritivas

```{r }
dados %<>% mutate( quality = as.numeric(quality),
                  qualidade = lvls_reorder(map_chr(quality,cl),c(2,3,1)))

corrplot::corrplot(cor(dados[1:12]),method="ellipse",order = "hclust", addrect=NULL)

cbind(
cor(x=red[,1:11], y=red$quality),
cor(x=white[,1:11], y=white$quality))
indep <- c("vinho","volatile.acidity","sulphates","alcohol",
           "density","chlorides")
data <- dados %>% select(indep,quality,qualidade)
corrplot::corrplot(cor(data[2:5]),method="ellipse",order = "hclust", addrect=NULL)
set.seed(1)
sample_rows <- sample(1:nrow(data), nrow(data)*.75)
train <- data[sample_rows,]
test <- data[-sample_rows,]
glimpse(dados)
dados %<>% mutate( quality = as.numeric(quality),
                  qualidade = lvls_reorder(map_chr(quality,cl),c(2,3,1)))
library(xtable)
descritivas <- 
dados %>% select_if(.predicate = is.numeric) %>% 
  gather(coluna,valores) %>% 
  group_by(coluna) %>% 
  summarise_if(.predicate = function(x) is.numeric(x),
                  .funs = c(Media = "mean",
                     DP = "sd",
                     Var. = "var",
                     Minimo = "min",
                     CV =  "cv",
                     Mediana = "median",
                     Maximo = "max",
                     n = "length")) %>% 
  mutate_if(.predicate = is.numeric,funs(round(.,3)))
a <- xtable(descritivas)
print.xtable(a, type="latex", file="aa.tex")


```

##variavel resposta

```{r}
ggplot(dados,aes(quality)) + stat_count()
table(dados$quality)
ggplot(dados,aes(qualidade)) + stat_count()
table(dados$qualidade)
```

```{r}
#ANALISANDO POSSIVEIS VARIAVEIS INFLUENTES NA ANALISE NA QUALIDADE DO VINHO
#Começarei analisando o alcool, açucar, ph
myCol <- brewer.pal(8, "Dark2")
dados %<>%  mutate(quality = factor(quality))
p1 <- dados %>% ggplot(aes(quality,alcohol,fill = quality,group = quality)) +
  geom_boxplot(show.legend = F) +
  theme_bw() +
  labs(y="Porcentagem (%)", title = "Porcentagem de Alcool por\n Qualidade",x=NULL) +
  theme(plot.title = element_text(size = 12,lineheight=.8,  
  face="bold",hjust = 0.5),text=element_text(size=12,  family="sans")) +
  scale_fill_manual(values = myCol) 


p2 <- dados %>% ggplot(aes(quality,pH,fill = quality,group = quality)) +
  geom_boxplot(show.legend = F) +
  theme_bw() +
  labs(y="Valores do pH (0-14)", title = "pH do vinho por\n Qualidade",x=NULL) +
  theme(plot.title = element_text(size = 12,lineheight=.8,  
  face="bold",hjust = 0.5),text=element_text(size=12,  family="sans")) +
  scale_fill_manual(values = myCol) 


p3 <- dados %>% ggplot(aes(quality,residual.sugar,fill = quality,group = quality)) +
  geom_boxplot(show.legend = F) +
  theme_bw() +
  labs(y="Açucar residual (gramas)", title = "Açucar residual por\n Qualidade",x=NULL) +
  theme(plot.title = element_text(size = 12,lineheight=.8,  
  face="bold",hjust = 0.5),text=element_text(size=12,  family="sans")) +
  scale_fill_manual(values = myCol) 


p4 <- dados %>% ggplot(aes(quality,density,fill = quality,group = quality)) +
  geom_boxplot(show.legend = F) +
  theme_bw() +
  labs(y="Valores da densidade do vinho", title = "Densidade do vinho por\n Qualidade",x=NULL) +
  theme(plot.title = element_text(size = 12,lineheight=.8,  
  face="bold",hjust = 0.5),text=element_text(size=12,  family="sans")) +
  scale_fill_manual(values = myCol) 

grid.arrange(p1,p2,p3,p4)
```

##arvore de decisao

```{r arvore de decisao}
dados %<>% select(-quality)
fit <- rpart(qualidade ~.,data = dados,method = "class",control = rpart.control(cp = 0))


plotcp(fit)
fit_pruned <- prune(fit, cp = 0.013)
dados$pred <- predict(newdata = dados,fit_pruned,type = "class")
##cunfision matrix
table(predito = dados$pred,real = dados$qualidade)


##precisao
mean(dados$pred == dados$qualidade)
dados$qualidade1 <- "Medio"
mean(dados$pred == dados$qualidade1)
library(rpart.plot)
# Plot the loan_model with default settings


# Plot the loan_model with customized settings
rpart.plot(fit_pruned, type = 3, fallen.leaves = TRUE,cex = 0.35)
```

```{r}
#USADO PCA
wine <- dados[,1:11]
wine.pca <- prcomp(wine, scale. = TRUE)
ggbiplot(wine.pca, obs.scale = 1, var.scale = 1,
         groups = dados[,13], ellipse = TRUE, circle = TRUE) +
  scale_color_discrete(name = '') +
  theme(legend.direction = 'horizontal', legend.position = 'top') + theme_bw()


#A PARTIR DAQUI, DEVIDO A SEPARACAO DOS GRUPOS, RESOLVI ANALISAR SEPARADAMENTE
```


```{r echo=FALSE, warning=FALSE}
#FLORESTA ALEATORIA VINHO BRANCO E VERMELHO
dados$rating[5 >= dados$quality ] = "Ruim"
dados$rating[5< dados$quality & dados$quality < 7] = "Medio"
dados$rating[7<= dados$quality] = "Bom"
dados$rating = as.factor(dados$rating)

dados$rating = relevel(dados$rating, "Ruim")


model_RF = randomForest(rating ~ . -vinho -quality, data=dados)
print(model_RF) 

print(importance(model_RF,type = 2)) 

pred_RF = predict(model_RF)
```

```{r echo=FALSE}
table(dados$rating, pred_RF)
#(1873+2302+840)/(1873+497+14+385+2302+149+26+411+840) = 0.77 precisao
#Da floresta aleatório mostrado acima, podemos concluir que o alcool  eh um fator importante que na qualidade do vinho (ruim, bom, medio). Além disso, o modelo tem apenas 23% de erro que significa que podemos prever com precisão de 77%.
```

```{r echo=FALSE, warning=FALSE}
#FLORESTA ALEATORIA - VINHO VERMELHO
red$rating[5 >= red$quality ] = "Ruim"
red$rating[5< red$quality & red$quality < 7] = "Medio"
red$rating[7<= red$quality] = "Bom"
red$rating = as.factor(red$rating)

red$rating = relevel(red$rating, "Ruim")


V_model_RF = randomForest(rating ~ . -vinho -quality, data=red)
print(model_RF) 

print(importance(V_model_RF,type = 2)) 

V_pred_RF = predict(V_model_RF)
```

```{r echo=FALSE, warning=FALSE}
#FLORESTA ALEATORIA - VINHO BRANCO
white$rating[5 >= white$quality ] = "Ruim"
white$rating[5< white$quality & white$quality < 7] = "Medio"
white$rating[7<= white$quality] = "Bom"
white$rating = as.factor(white$rating)

white$rating = relevel(white$rating, "Ruim")


B_model_RF = randomForest(rating ~ . -vinho -quality, data=white)
print(B_model_RF) 

print(importance(B_model_RF,type = 2)) 

B_pred_RF = predict(B_model_RF)
```

```{r}
ggplot(data = dados, aes(y = alcohol, x = quality)) +
   geom_point(alpha = 1/4, position = position_jitter(h = 0), size = 1, col = "red") +
   geom_smooth(method = 'lm') +
   facet_wrap(~ vinho)
```

```{r}
#ALCOOL VS DENSIDADE
dados$quality <- as.factor(dados$quality)

dados %>% ggplot(aes(x = density, y = alcohol, color = quality)) +
    facet_wrap(~vinho) + 
    geom_point(size = 3, alpha = 1/4) +
    scale_color_identity(guide = 'legend') +
    ylim(min(dados$alcohol), quantile(dados$alcohol, 0.95)) +
    xlim(min(dados$density), quantile(dados$density, 0.95)) +theme_bw()
```


```{r}
#ALCOOL VS ACIDEZ
dados$quality <- as.factor(dados$quality)

dados %>% ggplot(aes(x = volatile.acidity, y = alcohol, color = quality)) +
    facet_wrap(~vinho) + 
    geom_point(size = 3, alpha = 1/4) +
    scale_color_identity(guide = 'legend') +
    ylim(min(dados$alcohol), quantile(dados$alcohol, 0.95)) +
    xlim(min(dados$volatile.acidity), quantile(dados$volatile.acidity, 0.95)) +theme_bw()
```

```{r}
#ALCOOL VS ACIDEZ
dados$quality <- as.factor(dados$quality)

dados %>% ggplot(aes(x = volatile.acidity, y = density, color = quality)) +
    facet_wrap(~vinho) + 
    geom_point(size = 3, alpha = 1/4) +
    scale_color_identity(guide = 'legend') +
    ylim(min(dados$density), quantile(dados$density, 0.95)) +
    xlim(min(dados$volatile.acidity), quantile(dados$volatile.acidity, 0.95))  +theme_bw()
```

```{r}
#SULFATO VS ALCOOL
dados$quality <- as.factor(dados$quality)

dados %>% ggplot(aes(x = sulphates, y = alcohol, color = quality)) +
    facet_wrap(~vinho) + 
    geom_point(size = 3, alpha = 1/4) +
    scale_color_identity(guide = 'legend') +
    ylim(min(dados$alcohol), quantile(dados$alcohol, 0.95)) +
    xlim(min(dados$sulphates), quantile(dados$sulphates, 0.95)) +theme_bw()
```
